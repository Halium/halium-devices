#!/bin/bash

export DEVICE=${DEVICE:=${1}}
JOBS=${JOBS:=12}

export DEVICES_ROOT="$(dirname "$(readlink -f "${0}")")"
export REPO_ROOT="${DEVICES_ROOT}/../.."

if [ -z $DEVICE ]; then
	echo "Please specify a device codename"
	exit 0
fi

if [ -f $DEVICES_ROOT/manifests/*$DEVICE.xml ]; then
	echo "*****************************************"
	echo "Configuring for device $DEVICE"
	echo "*****************************************"

	# Test if there is already a device configured and the folder exists
	if [ -f $REPO_ROOT/.repo/local_manifests/device.xml ]; then
		rm $REPO_ROOT/.repo/local_manifests/device.xml
	elif ! [ -d $REPO_ROOT/.repo/local_manifests/ ]; then
		mkdir $REPO_ROOT/.repo/local_manifests/
	fi

	# Link the device manifest to the local_manifests folder
	ln $DEVICES_ROOT/manifests/*$DEVICE.xml $REPO_ROOT/.repo/local_manifests/device.xml

	# Synchronize new new sources
	repo sync --network-only -c -j$JOBS
	repo sync --local-only -c -j$JOBS

	# Set up build environment
	source $REPO_ROOT/build/envsetup.sh

	# Configure build environment for the specified device
	breakfast $DEVICE

	echo
	echo "*******************************************************************************************"
	echo "Run mka hybris-boot to buid the initrd, and then mka systemimage to build the android image"
	echo "*******************************************************************************************"
fi
